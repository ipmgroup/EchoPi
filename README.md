1. Общие сведения

Наименование проекта: Многофункциональный сонар на базе Raspberry Pi
Назначение: Активный акустический локатор для работы в воздушной и водной среде с использованием зондирующих сигналов типа чирп и корреляционной обработки.

Проект предназначен для исследовательского и прикладного использования, в том числе в робототехнике и БПЛА/БПА, с интеграцией в автопилот ArduPilot через MAVLink.

2. Функциональное назначение

Система должна обеспечивать:

Генерацию зондирующих сигналов (линейный/нелинейный чирп)

Излучение сигнала через усилитель и акустический излучатель

Приём отражённого сигнала с микрофона/гидрофона

Цифровую обработку сигнала (корреляция, оценка задержки, амплитуды)

Оценку дистанции до цели

Передачу результатов через GUI и MAVLink

Работу в режиме сервиса (daemon)

3. Условия эксплуатации
3.1 Среда

Воздух

Вода (пресная, морская — без калибровки солёности на первом этапе)

Переключение среды должно осуществляться программно.

3.2 Аппаратная платформа

Raspberry Pi (5 / CM5, уточняется)

ОС: Linux (Raspberry Pi OS / Ubuntu Server)

4. Аппаратная часть
4.0 Проверка применимости I2S-устройств (первый этап проекта)

Работы по проекту начинаются с верификации взаимодействия Raspberry Pi с I2S-устройствами и оценки их пригодности для задач сонара.

Цели этапа:

подтверждение стабильной работы I2S на частотах 96 кГц и выше;

проверка совместной работы устройств передачи и приёма;

экспериментальная оценка полосы, шума и задержек;

принятие решения о пригодности MAX98357 и INMP441 для дальнейших этапов.

Результаты этапа являются критерием Go / No-Go для продолжения проекта в выбранной конфигурации.




4.1 Вычислительная платформа

Raspberry Pi 4 / CM4

ОС: Linux (Raspberry Pi OS / Ubuntu Server)

4.2 Аудиотракт (начальный этап)

Интерфейс: I2S

4.2.1 Передача (TX)

I2S ЦАП с усилителем: MAX98357

Тип излучателя: динамик

Режим: моно

4.2.2 Приём (RX)

I2S микрофон: INMP441

Режим: моно

4.2.3 Общие требования к аудиотракту

Частота дискретизации: 96 кГц и выше

Разрядность: совпадает с INMP441 и MAX98357 (24 бита I2S)

Синхронная работа приёма и передачи

Общий тактовый домен I2S (BCLK/LRCLK)

Примечания:

На начальном этапе используется один канал приёма и один канал передачи

Возможность расширения до нескольких приёмных каналов рассматривается в дальнейшем

4.3 Настройка I2S на Raspberry Pi 5

ВАЖНО: Устройства подключаются к I2S (Inter-IC Sound), а не к I2C.

Подключение MAX98357 (TX) и INMP441 (RX):

Общие I2S сигналы (от Pi к обоим устройствам):
- BCLK (Bit Clock) → GPIO 18
- LRCLK/WS (Word Select) → GPIO 19
- DOUT (от INMP441 к Pi) → GPIO 20
- DIN (от Pi к MAX98357) → GPIO 21

MAX98357 подключение:
- VIN → 5V
- GND → GND
- DIN → GPIO 21 (PCM_DOUT)
- BCLK → GPIO 18
- LRCLK → GPIO 19

INMP441 подключение:
- VDD → 3.3V
- GND → GND
- SD → GPIO 20 (PCM_DIN)
- WS → GPIO 19
- SCK → GPIO 18
- L/R → GND (левый канал)

Настройка /boot/firmware/config.txt:

Добавить в конец файла:

```
# I2S аудио
dtparam=i2s=on

# MAX98357A DAC (воспроизведение)
dtoverlay=i2s-mmap
dtoverlay=googlevoicehat-soundcard
```

Альтернативная конфигурация (если googlevoicehat не работает):

```
dtparam=i2s=on
dtoverlay=i2s-mmap
dtoverlay=hifiberry-dac
```

Для INMP441 может потребоваться:

```
dtoverlay=i2s-mmap
dtoverlay=rpi-simple-soundcard,card_name="inmp441"
```

После изменения config.txt:

```bash
sudo reboot
```

Проверка устройств:

```bash
# Проверить загрузку I2S
lsmod | grep snd

# Список устройств воспроизведения
aplay -l

# Список устройств записи
arecord -l

# Детальная информация
cat /proc/asound/cards
```

Ожидаемый результат:
- Должны появиться карты с именами типа "googlevoicehat", "hifiberry", "inmp441" или "bcm2835 I2S"
- Для MAX98357: устройство воспроизведения (playback)
- Для INMP441: устройство записи (capture)

Примечание для Raspberry Pi 5:
- На Pi 5 используется новый конфиг /boot/firmware/config.txt (не /boot/config.txt)
- Device tree overlays могут отличаться от Pi 4
- При проблемах с 96 кГц попробуйте начать с 48 кГц и проверить стабильность

Проверенная конфигурация для Pi 5 (48 кГц):
```
dtparam=i2s=on
dtoverlay=i2s-mmap
dtoverlay=googlevoicehat-soundcard
```

Устройство появится как: `snd_rpi_googlevoicehat_soundcar` (hw:0,0)
Для тестирования используйте --sr 48000 во всех командах.

Измеренная задержка loop-back: ~2.5 мс при 48 кГц.

**Конфигурация для Pi 5 с поддержкой 96 кГц:**

Вариант 1 - Custom overlay (рекомендуется для 96 кГц):
```
dtparam=i2s=on
dtoverlay=i2s-mmap
dtoverlay=echopi-i2s-96k
```

Файл overlay: `/boot/firmware/overlays/echopi-i2s-96k.dtbo`
Исходник: `echopi-i2s-96k.dts` (в корне проекта)

Overlay использует `simple-audio-card` с двунаправленным I2S:
- `spdif-dit` (linux,spdif-dit) для воспроизведения через MAX98357
- `spdif-dir` (linux,spdif-dir) для записи с INMP441
- Без жёсткого ограничения частоты дискретизации

Устройство появится как: `echopi-i2s` (hw:0,0)

Вариант 2 - Стандартный overlay (только 48 кГц):
```
dtparam=i2s=on
dtoverlay=i2s-mmap
dtoverlay=googlevoicehat-soundcard
```
Устройство: `googlevoicehat` (hw:0,0) - работает, но ограничен 48 кГц

Примечание: 
- MAX98357 и INMP441 поддерживают 96 кГц аппаратно
- googlevoicehat-soundcard ограничен 48 кГц на уровне драйвера
- audioinjector-bare-i2s предоставляет только выход (out=8, in=0)
- После изменения overlay требуется перезагрузка: `sudo reboot`

Для пересборки overlay:
```bash
cd /home/pi/src/EchoPi5
dtc -@ -I dts -O dtb -o echopi-i2s-96k.dtbo echopi-i2s-96k.dts
sudo cp echopi-i2s-96k.dtbo /boot/firmware/overlays/
sudo reboot
```

5. Программная архитектура
5.1 Общая структура

Система реализуется в виде сервиса и включает:

Модуль генерации сигналов

Модуль приёма и буферизации

Модуль цифровой обработки сигналов (DSP)

Модуль оценки параметров цели

Коммуникационные интерфейсы

GUI

5.2 Режим работы

Автономный (по таймеру)

По команде (GUI / MAVLink)

6. Алгоритмы обработки
6.1 Зондирующий сигнал

Тип сигнала: линейный частотно-модулированный чирп (LFM)

Частота дискретизации: 96 кГц и выше

Полоса сигнала B определяется выбранной частотой дискретизации и требованиями к разрешению

Примечания:

Дальность обнаружения определяется излучаемой акустической мощностью и чувствительностью приёмника

Разрешение по дальности определяется полосой чирпа

Оценка разрешения по дальности:

ΔR = c / (2 · B)

где:

c — скорость звука в среде

B — полоса чирпа

6.2 Связь частоты дискретизации и полосы

Частота дискретизации должна быть не менее чем в 2 раза выше верхней частоты чирпа (Nyquist)

Рекомендуется oversampling ×2…×4 относительно минимально допустимого

Примеры:

Fs = 96 кГц → рабочая полоса до ~40 кГц

Fs = 192 кГц → рабочая полоса до ~80 кГц

6.3 Обработка сигнала

Предварительная полосовая фильтрация

Компенсация постоянной составляющей

Оконная обработка

Корреляция принятого сигнала с опорным (FFT-based)

Zero-padding для повышения точности оценки задержки

Поиск максимума корреляционной функции

Sub-sample интерполяция пика (парабола / sinc)

6.4 Временные и вычислительные ограничения

Обработка должна выполняться быстрее периода зондирования

Python допускается для прототипирования и оценки алгоритмов

Для Fs ≥ 192 кГц и длинных чирпов может потребоваться перенос DSP в C++/Rust

7. Интерфейсы
7.1 GUI

Локальный GUI (Qt / Web / уточняется)

Отображение:

Сырого сигнала

Корреляции

Оценки дистанции

Состояния системы

Управление параметрами чирпа

7.2 MAVLink / ArduPilot

Поддержка:

Передачи измеренной дистанции (аналог DISTANCE_SENSOR)

Получения команд запуска/остановки

Изменения режимов работы

8. Нефункциональные требования

Реальное время (задержка обработки < X мс)

Модульность

Возможность расширения (массив датчиков, другие сигналы)

Логирование данных

9. Этапы разработки

Формирование требований и выбор элементной базы

Реализация генерации и приёма

Реализация DSP и корреляции

Интеграция GUI

Интеграция MAVLink

Тестирование в воздухе

Тестирование в воде

10. Открытые вопросы

Частотный диапазон излучателя

Тип динамика / гидрофона

Максимальная акустическая мощность

Требуемая дальность в воздухе и воде

Допустимая вычислительная задержка

11. Репозиторий и кодовая база (первичный каркас)

Структура

- src/echopi — исходный код
	- config.py — конфигурации аудио и чирпа
	- cli.py — CLI-утилиты
	- dsp/chirp.py — генерация зондирующих сигналов
	- dsp/correlation.py — корреляция и интерполяция пика
	- io/audio.py — обёртки над sounddevice (I2S/ALSA)
	- utils/latency.py — измерение задержки воспроизведение→запись
- requirements.txt — зависимости (numpy, scipy, sounddevice, soundfile)

Установка окружения

- sudo apt-get install libportaudio2 libsndfile1
- python -m venv .venv && source .venv/bin/activate
- pip install -e .

CLI (после pip install -e .): echopi <команда>

- devices — показать список устройств ALSA/I2S
- generate-chirp out.wav [--sr 96000 --start 2000 --end 20000 --duration 0.05 --amp 0.8]
- play file.wav [--play-device <id> --sr 96000]
- tone [--freq 1000 --seconds 1 --amp 0.8 --play-device <id> --sr 96000] — тестовый синус
- record out.wav [--seconds 5 --rec-device <id> --sr 96000]
- monitor [--rec-device <id> --sr 96000] — онлайн RMS микрофона
- scope [--rec-device <id> --sr 96000] — осциллограф+спектр (pyqtgraph)
- check-device [--play-device <id> --rec-device <id> --sr 96000] — проверить доступность устройств
- latency [--play-device <id> --rec-device <id> --sr 96000 --start 2000 --end 20000 --duration 0.05 --amp 0.8]
- distance [--play-device <id> --rec-device <id> --sr 96000 --medium air|water --sys-latency 0.001357] — измерить расстояние до цели

Как мерить задержку I2S

1. Подключить MAX98357 (TX) и INMP441 (RX) к общему BCLK/LRCLK.
2. Выбрать устройства: echopi devices.
3. Выполнить: echopi latency --play-device <TX> --rec-device <RX> --sr 48000.
4. Команда генерирует чирп, воспроизводит его и параллельно пишет звук; задержка оценивается по корреляции.

Как измерить расстояние до объекта

1. Подключить MAX98357 (TX) и INMP441 (RX) к общему BCLK/LRCLK.
2. Направить динамик и микрофон на цель.
3. Измерить системную задержку: echopi latency --play-device 0 --rec-device 0 --sr 48000
4. Измерить расстояние: echopi distance --play-device 0 --rec-device 0 --sr 48000 --medium air --sys-latency 0.001357
5. Для воды использовать --medium water

Примечания по измерению расстояния:
- Эталонный чирп формируется с окном (Tukey через fade_fraction) - обязательно для минимизации боковых лепестков
- Корреляция выполняется с тем же чирпом, который был излучен
- Системная задержка вычитается из общего времени распространения
- Разрешение по дальности: ΔR = c / (2B), где B - полоса чирпа
  - Воздух (2-20 кГц): ~9.5 мм
  - Вода (2-20 кГц): ~41 мм
- Минимальная дальность ограничена системной задержкой (~23 см в воздухе, ~100 см в воде)
- SNR улучшается с увеличением длительности чирпа (по умолчанию 50 мс)

Как мониторить микрофон онлайн

1. Запустить: python -m echopi.cli monitor --rec-device <RX> --sr 96000.
2. В терминале отображается RMS; можно использовать для проверки шума/полосы.

Визуализация (pyqtgraph)

1. Убедиться, что установлены зависимости PyQt5/pyqtgraph (pip install -e . уже включает).
2. Запустить: echopi scope --rec-device <RX> --sr 96000.
3. Откроется окно с осциллографом (волна) и спектром (FFT) в реальном времени.

Как проиграть тестовый сигнал

1. Сгенерировать чирп: python -m echopi.cli generate-chirp chirp.wav --sr 96000.
2. Проиграть: python -m echopi.cli play chirp.wav --play-device <TX>.

Заметки

- I2S-устройства подаются через ALSA (см. arecord -l / aplay -l) и передаются в sounddevice по индексу или имени.
- frames_per_buffer по умолчанию 2048; уменьшение снижает задержку, но повышает риск XRUN.
- Для частот 192 кГц важно убедиться, что конкретные драйверы поддерживают нужный BCLK.