# Интерактивный GUI Сонара

## Обзор

Интерактивный GUI сонара предоставляет полный контроль над параметрами измерений и визуализацию результатов в реальном времени.

## Запуск

```bash
# Базовый запуск
DISPLAY=:0 echopi sonar --rec-device 0 --play-device 0 --sr 48000

# Полноэкранный режим
DISPLAY=:0 echopi sonar --rec-device 0 --play-device 0 --sr 48000 --fullscreen
```

## Функции

### Панель управления

**START/STOP SONAR** - Кнопка запуска/остановки измерений
- Зеленая = СТАРТ
- Красная = СТОП

### Результаты измерений

Отображаются в режиме реального времени:
- **Distance**: Дистанция до цели (метры и сантиметры)
- **Time of Flight**: Время полета сигнала (миллисекунды)
- **Peak**: Пик корреляции (качество сигнала)
- **Sound Speed**: Скорость звука в среде (м/с)
- **Measurements**: Счетчик измерений

### Параметры чирпа

Можно изменять во время работы:

**Start Freq** (100-24000 Hz)
- Начальная частота чирпа
- По умолчанию: 2000 Hz
- Рекомендуется: 2000-5000 Hz для воздуха

**End Freq** (100-24000 Hz)
- Конечная частота чирпа
- По умолчанию: 20000 Hz
- Рекомендуется: 15000-20000 Hz для воздуха

**Duration** (0.01-1.0 s)
- Длительность чирпа
- По умолчанию: 0.05 с (50 мс)
- Короткий чирп = лучшее разрешение
- Длинный чирп = лучшее SNR

**Amplitude** (0.1-1.0)
- Амплитуда сигнала
- По умолчанию: 0.8
- Регулируется слайдером

### Настройки системы

**Medium** (air/water)
- Среда распространения
- air: 343 м/с
- water: 1480 м/с

**Sys Latency** (0-0.1 s)
- Системная задержка
- По умолчанию: 0.00121 с (1.21 мс)
- Для точных измерений необходимо калибровать!

**Measure Latency** - Кнопка автоматического измерения
- ⚠️ **ВАЖНО**: Поместите динамик близко к микрофону (1-5 см)
- Выполняет автоматическое измерение системной задержки
- Автоматически обновляет значение Sys Latency
- Занимает ~1 секунду
- **Сонар должен быть остановлен** для измерения

**Update Rate** (0.1-10 Hz)
- Частота обновления измерений
- По умолчанию: 2 Hz (каждые 0.5 с)
- Выше = больше нагрузка на CPU

### Графики

**Distance History**
- График истории измерений дистанции
- Ось X: номер измерения
- Ось Y: дистанция (м)
- Максимум 100 точек

**Time of Flight History**
- График времени полета
- Ось X: номер измерения
- Ось Y: время (мс)

### Кнопка Clear History
- Очистка графиков
- Сброс счетчика измерений
- Не останавливает сонар

## Производительность

CPU использование при 48 кГц, update rate 2 Hz:
- Оконный режим: ~3-4%
- Полноэкранный режим: ~5-6%

## Калибровка системной задержки

### Автоматическое измерение (в GUI)

1. **Остановите сонар** (если запущен)
2. **Поместите динамик БЛИЗКО к микрофону** (1-5 см)
3. Нажмите кнопку **"Measure Latency"**
4. Дождитесь завершения измерения (~1 секунда)
5. Значение автоматически обновится в поле "Sys Latency"

⚠️ **Важно**: Для точного измерения латентности динамик должен находиться очень близко к микрофону!

### Ручное измерение (через CLI)

Перед использованием можно также откалибровать через командную строку:

```bash
# Выполните 5 измерений
for i in {1..5}; do
  echo "=== Измерение $i ==="
  echopi latency --rec-device 0 --play-device 0 --sr 48000
done
```

Используйте среднее значение в поле **Sys Latency**.

## Рекомендации

### Для точных измерений

1. Откалибруйте системную задержку (кнопка "Measure Latency" в GUI)
2. Динамик должен быть БЛИЗКО к микрофону при калибровке!
3. Используйте стабильную температуру (влияет на скорость звука)
3. Минимизируйте фоновый шум
4. Используйте короткие чирпы (0.03-0.05 с)
5. Проверяйте качество сигнала (Peak > 100)

### Для дальних измерений

1. Увеличьте длительность чирпа (0.1-0.2 с)
2. Увеличьте амплитуду (0.9-1.0)
3. Используйте более широкую полосу частот
4. Уменьшите update rate для снижения нагрузки

### Для ближних измерений

1. Используйте короткие чирпы (0.03-0.05 с)
2. Высокая частота обновления (5-10 Hz)
3. Проверьте минимальную дистанцию (зависит от длительности чирпа)

## Ограничения

**Минимальная дистанция**: зависит от длительности чирпа
- Chirp 0.05 с → ~17 см (воздух)
- Chirp 0.1 с → ~34 см (воздух)

**Максимальная дистанция**: зависит от:
- Мощности излучателя
- Чувствительности микрофона
- Уровня шума
- Отражающей способности цели

Типовая дальность для Google voiceHAT:
- Плоская поверхность: 2-5 м
- Углы/края: 1-3 м

## Интеграция с сервисом

GUI сонара может работать параллельно с системным сервисом:
- Сервис продолжает работу в фоне
- GUI использует те же параметры измерений
- Изменения в GUI не влияют на сервис

Для интеграции с MAVLink см. [README.md](../README.md).

## Горячие клавиши

- **Esc** - Выход из полноэкранного режима
- **Q** - Закрыть приложение

## Troubleshooting

### GUI не запускается

Проверьте X11 сервер:
```bash
ps aux | grep X | grep -v grep
```

Если не запущен:
```bash
sudo xinit /usr/bin/openbox-session -- :0 vt1 &
```

### Не удается измерить латентность

1. **Динамик БЛИЗКО к микрофону** (1-5 см) - самое важное!
2. Проверьте аудио устройства: `echopi devices`
3. Убедитесь что нет посторонних шумов
4. Проверьте громкость динамика
5. Остановите сонар перед измерением

### Нет измерений / Distance = 0

1. Проверьте аудио устройства: `echopi devices`
2. Проверьте подключение микрофона и динамика
3. Увеличьте амплитуду
4. Проверьте уровень фонового шума
5. Убедитесь, что перед датчиком есть отражающая поверхность

### Нестабильные измерения

1. Откалибруйте системную задержку
2. Проверьте качество сигнала (Peak)
3. Увеличьте длительность чирпа
4. Минимизируйте вибрации
5. Улучшите звукоизоляцию между излучателем и микрофоном

### Высокая нагрузка CPU

1. Уменьшите update rate
2. Используйте оконный режим вместо fullscreen
3. Уменьшите sample rate (если возможно)
