# EchoPi Diagnostic Guide

## Проблемы и решения

### 1. GUI падает после нескольких измерений

**Причины:**
- Утечка памяти (memory leak)
- Неправильная обработка исключений
- Переполнение буфера истории

**Решение:**
```bash
# Запустите тест с мониторингом
python test_distance_check.py
```

**Мониторинг памяти в GUI:**
- Теперь GUI показывает текущее использование памяти
- Если память растет > 100 MB - есть утечка
- Ограничение истории: 100 измерений

### 2. Дистанция измеряется неправильно

**Возможные причины:**

#### A. Неправильное значение system_latency

**Симптомы:**
- Отрицательная дистанция → latency слишком большое
- Дистанция всегда 0 → нет сигнала или latency неправильное

**Решение:**
```bash
# 1. Измерьте latency (динамик БЛИЗКО к микрофону 1-5 см)
echopi latency

# 2. Проверьте сохранённое значение
echopi config --show

# 3. Если нужно, задайте вручную
echopi config --set-latency 0.001357
```

#### B. Слабый сигнал

**Симптомы:**
- Peak < 0.1
- Нестабильные измерения

**Решение:**
- Увеличьте громкость
- Увеличьте amplitude (0.8-1.0)
- Уменьшите фоновый шум
- Приблизьте объект (0.5-2 м оптимально)

#### C. Нет соединения

**Симптомы:**
- Дистанция всегда 0
- Нет эха

**Решение:**
- Проверьте подключение динамика/микрофона
- Проверьте `arecord -l` и `aplay -l`
- Тест аудио: `echopi scope`

### 3. GUI не запускается

**Причины:**
- Нет X11 сервера
- Нет виртуального окружения
- Отсутствуют зависимости

**Решение:**
```bash
# Активируйте окружение
source .venv/bin/activate

# Установите зависимости
pip install -e .

# Проверьте X11
echo $DISPLAY

# Запустите GUI
echopi sonar --gui
```

## Тестовые скрипты

### Полная диагностика
```bash
python test_distance_check.py
```

**Что делает:**
1. Измеряет system latency
2. Выполняет 5 измерений дистанции
3. Показывает статистику
4. Проверяет память

### Быстрый тест CLI
```bash
# Одно измерение
echopi distance

# С известной дистанцией для калибровки
echopi distance --sys-latency 0.001357
```

### Тест GUI
```bash
echopi sonar --gui
```

**Проверьте в GUI:**
- Отображение памяти (Memory: XX MB)
- Предупреждения в красной области
- Стабильность измерений

## Рекомендации по использованию

### Измерение system_latency
1. Разместите динамик БЛИЗКО к микрофону (1-5 см)
2. Обеспечьте тишину
3. Запустите: `echopi latency` или кнопка "Measure Latency" в GUI
4. Значение автоматически сохранится в `~/.config/echopi/init.json`

### Измерение дистанции
1. Разместите объект на известном расстоянии (0.5-2 м)
2. Убедитесь что latency измерена
3. Запустите `echopi distance` или `echopi sonar --gui`
4. Проверьте:
   - Peak > 0.1 (хороший сигнал)
   - Дистанция положительная
   - Стабильность ±1-2 см

### Мониторинг производительности

**Признаки утечки памяти:**
- Память растет с каждым измерением
- GUI тормозит после 50+ измерений
- Система начинает свопить

**Действия:**
- Перезапустите GUI
- Уменьшите Update Rate
- Сократите историю (max_history)

## Файлы конфигурации

### ~/.config/echopi/init.json
```json
{
  "system_latency_s": 0.00121,
  "sample_rate": 96000,
  "version": "0.0.1"
}
```

**Параметры:**
- `system_latency_s` - задержка системы в секундах (критически важно!)
- `sample_rate` - частота дискретизации
- `version` - версия конфигурации

## Debug режим

### Включить подробные логи
```python
# В sonar.py уже включен traceback при ошибках
# Смотрите консоль при запуске GUI
```

### Проверка Core echopi
```bash
# Убедитесь что Core echopi работает
python -c "from echopi.utils.distance import measure_distance; print('OK')"
python -c "from echopi.utils.latency import measure_latency; print('OK')"
```

## Частые вопросы

**Q: Почему дистанция отрицательная?**
A: System latency слишком большое. Перемерьте: `echopi latency`

**Q: Почему дистанция всегда 0?**
A: Нет сигнала. Проверьте соединения, громкость, наличие объекта.

**Q: GUI падает через несколько минут**
A: Возможна утечка памяти. Следите за "Memory: XX MB" в GUI.

**Q: Измерения нестабильные (разброс > 10 см)**
A: Слабый сигнал или помехи. Увеличьте amplitude, уменьшите шум.

**Q: Где сохраняется latency?**
A: В `~/.config/echopi/init.json` - создается автоматически.

**Q: Как сбросить настройки?**
A: Удалите `~/.config/echopi/init.json` - будут использованы дефолтные значения.
